<h1>Change Your Password</h1>
<form id="change-password" class="pure-form pure-form-aligned">
    <fieldset>
        <div class="pure-control-group">
            <label for="current-password">Current Password</label>
            <input id="current-password" name="current-password" type="password" required>
        </div>

        <br/>

        <div class="pure-control-group">
            <label for="new-password">New Password</label>
            <input id="new-password" name="new-password" type="password" required>
        </div>

        <div class="pure-control-group">
            <label for="new-password-again">Repeat New Password</label>
            <input id="new-password-again" name="new-password-again" type="password" required>
        </div>

        <div class="pure-controls">
            <button type="submit" class="pure-button red-button">Change My Password</button>
        </div>
    </fieldset>
</form>

<script>
    setTitle('Change Your Password - Snap! Build Your Own Blocks');

    document.querySelector('form#change-password').addEventListener('submit', function (event) {
        var username = SnapAPI.currentUser(),
            current = this.elements['current-password'].value,
            newPassword = this.elements['new-password'].value,
            repeatedPassword = this.elements['new-password-again'].value;

        event.preventDefault();

        SnapAPI.setUser(username, current)
            .then(function (value) {
                if (newPassword === repeatedPassword) {
                    SnapAPI.resetPassword(username)
                        .then(function () {
                            localStorage['password'] = newPassword;
                            SnapAPI.relogin();
                            alert('Password changed successfully.');
                        })
                        .catch(function (value) {
                            genericError(
                                'Failed to change password. The server reported<br/>'
                                    + value.ResultMessage,
                                'Password Change Failed');
                        });
                } else {
                    genericError('Passwords do not match.');
                }
            })
            .catch(function () {
                genericError('Current password is wrong.');
            });
    });
</script>

